#!/usr/bin/env bash
set -euo pipefail

# ==================== GLOBALS ====================
# Script Info
VERSION="1.0"
ROOT_DIR=$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")

# Flags
SIMULATE=false
RESTOW=false
DIRS=();

# ==================== INCLUDES ====================
for f in $ROOT_DIR/shared/*.sh; do source $f; done
for f in $ROOT_DIR/include/*.sh; do source $f; done

# ==================== UTILS ====================

function log() {
	local original_args=("$@")
	[[ "$1" == "echo" ]] && shift;

	printf "   "
	if [[ $SIMULATE == true ]]; then
		echo -n "$(yellow)$@$(reset)"
		return -1
	else
		echo "$@"
		${original_args[@]} >/dev/null
		return 0
	fi
}

function format_stow_output() {
	sed '/BUG in find_stowed_path?/d' \
	| sed 's/=>/->/g' \
	| sed "s/^LINK\: /$(green)  LINK: $(reset)/g" \
	| sed "s/^UNLINK\: /$(small;green)  UNLINK: $(reset)/g" \
	| sed "s/^WARNING\: /$(yellow) WARNING: $(reset)/g" \
	| sed "s/^WARNING\! /$(bold;red) WARNING! $(reset)/g"
}

# ==================== Implementation ====================

function stow() {
	local opts="-t$HOME -v  --dotfiles --ignore=install|\.gitignore"
	[[ $SIMULATE == true ]] && opts+=" --simulate";
	[[ $RESTOW == true ]] && opts+=" --restow";

  local out ; out="$(command stow $opts "$@" 2>&1)"
	local exit_code=$?

	if rg -q 'WARNING! stowing [\w-]* would cause conflicts' <<< "$out"; then
		handle_conflicts <<< "$out"
		[[ $SIMULATE == true ]] && return 0;
		out="$(command stow $opts "$@" 2>&1)"
		exit_code=$?
	fi

	format_stow_output <<< "$out"
	[[ $exit_code -ne 0 ]] && return 1;
	return 0;
}


function install_package() {
	center '-' 40 " $(cyan;bold)${1%/}$(reset) ";
	local dir="$1"

	[[ -f "${dir}/install" ]] && ( cd "$dir" && source ./install "$@");

	stow $dir || panic "$(bold;red)Install failed$(reset)"
}

function main() {
    parseArgs "$@"
	check_cmds stow rg

	[[ $SIMULATE == true ]] \
		&& echo "$(yellow;bold)Installing Dotfiles... (Simulating)$(reset)" \
		|| echo "$(bold)Installing Dotfiles...$(reset)"

	for d in "${DIRS[@]}"; do
		local package="${d%/}"

		install_package "$package"
	done
}

(cd "$ROOT_DIR/packages" && main "$@")
